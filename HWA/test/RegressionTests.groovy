def jobNames = [
  [
    JOBTITLE: 'Account - menu - XT-1956',
    COMPONENT: 'account',
    TESTCASE: 'menu'
  ],
  [
    JOBTITLE: 'Account - noLogo - XT-1861',
    COMPONENT: 'account',
    TESTCASE: 'noLogo'
  ],
  [
    JOBTITLE: 'Account - signOut - XT-1862',
    COMPONENT: 'account',
    TESTCASE: 'signOut'
  ],
  [
    JOBTITLE: 'App Launch - appLaunch - XT-1818',
    COMPONENT: 'appLaunch',
    TESTCASE: 'appLaunch'
  ],
  [
    JOBTITLE: 'Discover - defaultScreen - XT-1983',
    COMPONENT: 'discover',
    TESTCASE: 'defaultScreen'
  ],
  [
    JOBTITLE: 'Discover - discoverFilters',
    COMPONENT: 'discover',
    TESTCASE: 'discoverFilters'
  ],
  [
    JOBTITLE: 'Discover - generalAppearance - XT-1839',
    COMPONENT: 'discover',
    TESTCASE: 'generalAppearance'
  ],
  [
    JOBTITLE: 'Discover - navigationAndSelection - XT-1840',
    COMPONENT: 'discover',
    TESTCASE: 'navigationAndSelection'
  ],
  [
    JOBTITLE: 'Discover - showTiles - XT-1841',
    COMPONENT: 'discover',
    TESTCASE: 'showTiles'
  ],
  [
    JOBTITLE: 'HomeScreen - appearance - XT-1826',
    COMPONENT: 'homeScreen',
    TESTCASE: 'appearance'
  ],
  [
    JOBTITLE: 'HomeScreen - episodeActionModal - XT-1934',
    COMPONENT: 'homeScreen',
    TESTCASE: 'episodeActionModal'
  ],
  [
    JOBTITLE: 'HomeScreen - episodeTileNonActive - XT-1834',
    COMPONENT: 'homeScreen',
    TESTCASE: 'episodeTileNonActive'
  ],
  [
    JOBTITLE: 'HomeScreen - heroFlipper - XT-1828',
    COMPONENT: 'homeScreen',
    TESTCASE: 'heroFlipper'
  ],
  [
    JOBTITLE: 'HomeScreen - logo - XT-1827',
    COMPONENT: 'homeScreen',
    TESTCASE: 'logo'
  ],
  [
    JOBTITLE: 'HomeScreen - moreInfoHero - XT-1930',
    COMPONENT: 'homeScreen',
    TESTCASE: 'moreInfoHero'
  ],
  [
    JOBTITLE: 'HomeScreen - myStuffHeroFlipper - XT-1940',
    COMPONENT: 'homeScreen',
    TESTCASE: 'myStuffHeroFlipper'
  ],
  [
    JOBTITLE: 'HomeScreen - myStuffShowTiles - XT-1835',
    COMPONENT: 'homeScreen',
    TESTCASE: 'myStuffShowTiles'
  ],
  [
    JOBTITLE: 'HomeScreen - myStuffShowTilesNonActive - XT-1836',
    COMPONENT: 'homeScreen',
    TESTCASE: 'myStuffShowTilesNonActive'
  ],
  [
    JOBTITLE: 'HomeScreen - showActionModal - XT-1933',
    COMPONENT: 'homeScreen',
    TESTCASE: 'showActionModal'
  ],
  [
    JOBTITLE: 'HomeScreen - showTileNonActive - XT-1833',
    COMPONENT: 'homeScreen',
    TESTCASE: 'showTileNonActive'
  ],
  [
    JOBTITLE: 'HomeScreen - toolTip - XT-1932',
    COMPONENT: 'homeScreen',
    TESTCASE: 'toolTip'
  ],
  [
    JOBTITLE: 'MainMenu - collapsingMainMenu - XT-1873',
    COMPONENT: 'mainMenu',
    TESTCASE: 'collapsingMainMenu'
  ],
  [
    JOBTITLE: 'MainMenu - selectingHome - XT-1872',
    COMPONENT: 'mainMenu',
    TESTCASE: 'selectingHome'
  ],
  [
    JOBTITLE: 'Search - generalAppearance - XT-2018',
    COMPONENT: 'search',
    TESTCASE: 'generalAppearance'
  ],
  [
    JOBTITLE: 'Search - gridView - XT-1975',
    COMPONENT: 'search',
    TESTCASE: 'gridView'
  ],
  [
    JOBTITLE: 'Search - input - XT-1858',
    COMPONENT: 'search',
    TESTCASE: 'input'
  ],
  [
    JOBTITLE: 'Search - navigation - XT-1860',
    COMPONENT: 'search',
    TESTCASE: 'navigation'
  ],
  [
    JOBTITLE: 'Search - popularSearches - XT-1852',
    COMPONENT: 'search',
    TESTCASE: 'popularSearches'
  ],
  [
    JOBTITLE: 'Search - recentSearch - XT-1994',
    COMPONENT: 'search',
    TESTCASE: 'recentSearch'
  ],
  [
    JOBTITLE: 'Search - recentSearchAppearance - XT-1857',
    COMPONENT: 'search',
    TESTCASE: 'recentSearchAppearance'
  ],
  [
    JOBTITLE: 'Search - recentSearchSelect - XT-1853',
    COMPONENT: 'search',
    TESTCASE: 'recentSearchSelect'
  ],
  [
    JOBTITLE: 'Search - replaceRecentSearch - XT-1856',
    COMPONENT: 'search',
    TESTCASE: 'replaceRecentSearch'
  ],
  [
    JOBTITLE: 'Search - searchBar - XT-1859',
    COMPONENT: 'search',
    TESTCASE: 'searchBar'
  ],
  [
    JOBTITLE: 'Search - searchNoMtodLogo - XT-1854',
    COMPONENT: 'search',
    TESTCASE: 'searchNoMtodLogo'
  ],
  [
    JOBTITLE: 'Search - searchResults - XT-1855',
    COMPONENT: 'search',
    TESTCASE: 'searchResults'
  ],
  [
    JOBTITLE: 'Show - appearance - XT-1821',
    COMPONENT: 'show',
    TESTCASE: 'appearance'
  ],
  [
    JOBTITLE: 'Show - backNavigation - XT-1939',
    COMPONENT: 'show',
    TESTCASE: 'backNavigation'
  ],
  [
    JOBTITLE: 'Show - episodeNavigation - XT-1822',
    COMPONENT: 'show',
    TESTCASE: 'episodeNavigation'
  ],
  [
    JOBTITLE: 'Show - extrasNavigation - XT-1825',
    COMPONENT: 'show',
    TESTCASE: 'extrasNavigation'
  ],
  [
    JOBTITLE: 'Show - lastSeasonWatched - XT-1942',
    COMPONENT: 'show',
    TESTCASE: 'lastSeasonWatched'
  ],
  [
    JOBTITLE: 'Show - multipleSeasons - XT-1959',
    COMPONENT: 'show',
    TESTCASE: 'multipleSeasons'
  ],
  [
    JOBTITLE: 'Show - noContent - XT-2029',
    COMPONENT: 'show',
    TESTCASE: 'noContent'
  ],
  [
    JOBTITLE: 'Show - oneSeason - XT-1958',
    COMPONENT: 'show',
    TESTCASE: 'oneSeason'
  ],
  [
    JOBTITLE: 'Show - playCTA - XT-1918',
    COMPONENT: 'show',
    TESTCASE: 'playCTA'
  ],
  [
    JOBTITLE: 'Show - readMore - XT-1824',
    COMPONENT: 'show',
    TESTCASE: 'readMore'
  ],
  [
    JOBTITLE: 'Show - resumeCTA - XT-1919',
    COMPONENT: 'show',
    TESTCASE: 'resumeCTA'
  ],
  [
    JOBTITLE: 'Show - seasonNavigation - XT-1823',
    COMPONENT: 'show',
    TESTCASE: 'seasonNavigation'
  ],
  [
    JOBTITLE: 'Show - trailerAndClips - XT-1924',
    COMPONENT: 'show',
    TESTCASE: 'trailerAndClips'
  ],
  [
    JOBTITLE: 'Show - withoutEpisodes - XT-1923',
    COMPONENT: 'show',
    TESTCASE: 'withoutEpisodes'
  ],
  [
    JOBTITLE: 'Show - withoutExtras - XT-1928',
    COMPONENT: 'show',
    TESTCASE: 'withoutExtras'
  ],
  [
    JOBTITLE: 'SignIn - blankCreds - XT-1820',
    COMPONENT: 'signIn',
    TESTCASE: 'blankCreds'
  ],
  [
    JOBTITLE: 'SignIn - cancelledAccount - XT-1808',
    COMPONENT: 'signIn',
    TESTCASE: 'cancelledAccount'
  ],
  [
    JOBTITLE: 'SignIn - codeNotEntered - XT-1875',
    COMPONENT: 'signIn',
    TESTCASE: 'codeNotEntered'
  ],
  [
    JOBTITLE: 'SignIn - dalWeb - XT-1843',
    COMPONENT: 'signIn',
    TESTCASE: 'dalWeb'
  ],
  [
    JOBTITLE: 'SignIn - invalidCode - XT-1844',
    COMPONENT: 'signIn',
    TESTCASE: 'invalidCode'
  ],
  [
    JOBTITLE: 'SignIn - newCode - XT-1845',
    COMPONENT: 'signIn',
    TESTCASE: 'newCode'
  ],
  [
    JOBTITLE: 'SignIn - qrCode - XT-1847',
    COMPONENT: 'signIn',
    TESTCASE: 'qrCode'
  ],
  [
    JOBTITLE: 'SignIn - signIn - XT-1809',
    COMPONENT: 'signIn',
    TESTCASE: 'signIn'
  ],
  [
    JOBTITLE: 'SignIn - terminatedAccount - XT-1948',
    COMPONENT: 'signIn',
    TESTCASE: 'terminatedAccount'
  ],
  [
    JOBTITLE: 'SignIn - viewPassword - XT-1973',
    COMPONENT: 'signIn',
    TESTCASE: 'viewPassword'
  ],
  [
    JOBTITLE: 'Splash - splashScreenFunctionality - XT-1807',
    COMPONENT: 'splash',
    TESTCASE: 'splashScreenFunctionality'
  ]
]

def path = 'QA-Selenium/MTOD/Regression Tests/XTV Preprod/Test';
def env = 'xtv.preprod';

def index = 0;

// This is just a terminator string used below to simplify string handling
def tool = "'''";

// The following are to generate set jobs dynamically based in number of jobs and number of endpoints
// Number of expected set jobs
def numberOfSetJobs = 6
// String used to dynamically build the job stages (i.e. endpoints included in the set)
def setJobStages = ""
// Array holding copies of the above string, the final set jobs will be generated using these
def setJobsStagesStrings = []
// This just makes things easier
def maxStagesPerJob = Math.round(Math.ceil(jobNames.size/numberOfSetJobs))

jobNames.eachWithIndex{ currJobName, i ->
def int currentJobSet = Math.round(Math.floor(i/maxStagesPerJob))
if (setJobsStagesStrings.size < currentJobSet + 1) {
      setJobsStagesStrings.add([
        jobName: "${path}/${currentJobSet + 1} - Set Job ${currentJobSet + 1}",
        jobStages: "",
      ])
    }
    setJobsStagesStrings[currentJobSet]["jobStages"] = setJobsStagesStrings[currentJobSet]["jobStages"] + '''
  catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
      stage(''' + "'${currJobName["JOBTITLE"]}'" + ''') {
          build job: ''' + "'${currJobName["JOBTITLE"]}'" + ''', parameters: [string(name: 'ENV', value: String.valueOf(ENV)), string(name: 'BRANCH', value: String.valueOf(BRANCH))]
      }
  }
'''
  pipelineJob("${path}" + "/" + "${currJobName["JOBTITLE"]}") {
  definition {
      cps {
        script('''
          pipeline {
            agent {
              kubernetes {
                inheritFrom 'qa-automation-npm'
                label 'npm'
                yaml ''' + "${tool}" + '''
                spec:
                  containers:
                    - name: npm
                      image: 363308097987.dkr.ecr.us-west-2.amazonaws.com/jenkins-slave:node-05-15-2022
                      command:
                      - cat
                      tty: true
                  dnsPolicy: None
                  dnsConfig:
                      nameservers:
                        - 169.254.20.10
                        - 172.20.0.10
                      searches:
                        - selenium.svc.cluster.local
                        - svc.cluster.local
                        - cluster.local
                        - ec2.internal
                        - us-west-2.compute.internal
                      options:
                        - name: ndots
                          value: "1"
                        - name: attempts
                          value: "3"
                        - name: timeout
                          value: "1"
                        - name: rotate'''
                      + "${tool}" + '''
              }
            }
            parameters {
      choice(choices: ['xtv.preprod', 'xtv-dev'], description: '', name: 'ENV')
      string(defaultValue: 'main', description: '', name: 'BRANCH', trim: false)
      string(defaultValue: ''' + "'${currJobName["COMPONENT"]}'" + ''', description: '', name: 'COMPONENT', trim: false)
      string(defaultValue: ''' + "'${currJobName["TESTCASE"]}'" + ''', description: '', name: 'TESTCASE', trim: false)
      choice(choices: ['chrome', '', 'firetv', 'android', 'comcast'], description: '', name: 'DEVICE_TYPE')
      choice(choices: ['test', '', 'prod'], description: '', name: 'SONIC_BASE')
      string(defaultValue: '3', description: '', name: 'SLEEP', trim: false)
      string(defaultValue: '60', description: '', name: 'CHECKOUT_TIMEOUT', trim: false)
      string(defaultValue: '130', description: '', name: 'BUILD_TIMEOUT', trim: false)
      string(defaultValue: '360', description: '', name: 'TEST_TIMEOUT', trim: false)
      choice(choices: ['', '--loglevel warn', '--loglevel verbose'], 
      description: ' Select a log level, or leave empty if log is not needed', name: 'LOGLEVEL')
      password(name: 'PASSWORD', description: 'Email pass')
      password(name: 'BREACHED_PASSWORD', description: 'BREACHED Pass')
      password(name: 'ORG_PASSWORD', description: 'Org pass')
    }
            stages {
              stage('What Node') {
                steps {
                    container('npm') {
                      echo "we are running"
                      sh "node -v"
                    }
                }
              }
              stage('Checkout') {
                steps {
                    script {
                    try {
                        timeout(time: "${CHECKOUT_TIMEOUT}" as Integer, unit: 'SECONDS') {
                            git branch: '${BRANCH}',
                                credentialsId: 'github',
                                url: 'git@github.com:motortrend/motortrend-on-demand-web-automation.git'
                        }
                    } catch (err) {
                            retry(3) {
                                echo(err)
                                sleep(time:"${SLEEP}" as Integer,unit:"SECONDS")
                                timeout(time: "${CHECKOUT_TIMEOUT}" as Integer, unit: 'SECONDS') {
                                git branch: '${BRANCH}',
                                    credentialsId: 'github',
                                    url: 'git@github.com:motortrend/motortrend-on-demand-web-automation.git'
                                }
                            }
                        }
                    }
                }
          }
              stage('Build'){
                  steps {
                      script {
                          container ('qa-automation-npm'){
                              environment { 
                                  PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
                              }
                              try {
                                  timeout(time: "${BUILD_TIMEOUT}" as Integer, unit: 'SECONDS') {
                                      sh 'npm install --omit=dev'
                                  }
                              } catch (err) {
                                  echo "Build did not complete in 130 seconds, let's retry"
                                  retry(3) {
                                      sleep(time:"${SLEEP}" as Integer,unit:"SECONDS")
                                      timeout(time: "${BUILD_TIMEOUT}" as Integer, unit: 'SECONDS') {
                                          sh 'npm install --omit=dev'
                                      }
                                  }
                              }
                              
                              stage(''' + "'${currJobName["JOBTITLE"]}'" + ''') {
                                retry(3) {
                                  try {
                                      sleep(time:"${SLEEP}" as Integer,unit:"SECONDS")
                                      timeout(time: "${TEST_TIMEOUT}" as Integer, unit: 'SECONDS') {
                                          withCredentials([string(credentialsId: 'MTODPW', variable: 'PASSWORD'), string(credentialsId: 'OrgPw', variable: 'ORG_PASSWORD'), string(credentialsId: 'BreachedPW', variable: 'BREACHED_PASSWORD')]) {
                                          sh 'ENV=${ENV} DEVICE_TYPE=${DEVICE_TYPE} SONIC_BASE=${SONIC_BASE} COMPONENT=${COMPONENT} TESTCASE=${TESTCASE} PASSWORD=${PASSWORD} BREACHED_PASSWORD=${BREACHED_PASSWORD} ORG_PASSWORD=${ORG_PASSWORD} npm run hwa-kubernetes ${LOGLEVEL}'
                                          }
                                      }
                                  } catch (err) {
                                      error "Test did not complete in ${TEST_TIMEOUT} seconds"
                                  }
                                }
                              }
                          }
                      }
                  }
              }
            }
          }
          '''
          )
        }
      }
    }
    index += 1;
}

def triggerString = ""

  setJobsStagesStrings.each {stagesString ->
    triggerString = triggerString + "${stagesString["jobName"]},"
    pipelineJob("${stagesString["jobName"]}") {
      parameters {
        stringParam("ENV", 'xtv.preprod', "Environment being used for testing")
        stringParam('BRANCH', 'main', '')
      }
      definition {
        cps {
          script("${stagesString["jobStages"]}")
        }
      }
    }
  }

  job("${path}/0 - Run all set jobs") {
    triggers {
              cron '''H 2 * * 0-5'''
            }
    parameters {
      stringParam("ENV", 'xtv.preprod', "Environment being used for testing")
      stringParam('BRANCH', 'main', '')
    }
    steps {
          shell('''
            set ENV=$ENV
            echo ENV is $ENV
            set BRANCH=$BRANCH
            echo Branch is $BRANCH
            echo "triggerString: ''' + "${triggerString}" + '''"
          ''')
    }
    publishers {
      downstreamParameterized {
        trigger(triggerString) {
          condition('SUCCESS')
          parameters {
            currentBuild()
          }
        }
      }
    }
  }
  
  setJobsStagesStrings.clear();
